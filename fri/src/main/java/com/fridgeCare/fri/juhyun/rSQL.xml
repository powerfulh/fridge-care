<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="rSQL">

	
	<select id="getLikeCnt" resultType="int" parameterType="rVO">
		SELECT
			COUNT(*) lcnt
		FROM
			userlike
		WHERE
			lmno = #{mno}
    		AND lbno = #{bno}
	</select>
	
	<select id="getResipiInfo" resultType="rVO" parameterType="rVO">
		SELECT
		    tname dir, title, SUBSTR(video,INSTR(video,'v=')+2) video , bmno, bdate, lcount, cnt, time, bno ,
            (select id from member where mno = bmno) id
		FROM
		    board b, thumb t 
		WHERE
		    b.tno = t.tno
		    AND bno = #{bno}
	</select>
	
	<select id="getMno" resultType="int" parameterType="String">
		SELECT
			mno
		FROM
			member
		WHERE
			id = #{id}
	</select>
	
	<select id="getIngred" resultType="String" parameterType="int">
		SELECT
		    ingred
		FROM
		    board
		WHERE
		    bno = #{bno}
	</select>
	
	<select id="getBody" resultType="rVO" parameterType="int">
		SELECT
		    body, savename dir
		FROM
		    boardpart
		WHERE
		    bno = #{bno}
		order BY bpno
	</select>
	
	<select id="getReply" resultType="rVO" parameterType="rVO">
		SELECT
		    *
		FROM
		    (
		        SELECT
		            rownum rno, re.*
		        FROM
		            (SELECT
		                body, id ,redate bdate
		            FROM
		                reply, member, board
		            WHERE
		                bno = #{bno}
		                AND remno = mno
		                AND rebno = bno
		            ORDER BY
		                redate DESC) re
		    )
		WHERE
		    rno BETWEEN #{page.startCont} AND #{page.endCont}
	</select>
	
	<select id="getAllCnt" resultType="int">
		SELECT
		    COUNT(*) cnt
		FROM
		    reply, board
		WHERE
		    rebno = bno
		    AND bno = #{bno}
	</select>
	
	<select id="getReplyCnt" resultType="int" parameterType="rVO">
		SELECT
		    COUNT(*) cnt
		FROM
		    member, reply, board
		WHERE
		    mno = remno
		    AND rebno = bno
		    AND bno = #{bno}
		    AND id = #{id}
	</select>
	
	<select id="getOther" resultType="rVO">
		SELECT
		    bono, title, dir, bno
		FROM
		   (SELECT
		       rownum bono, b.*
		   FROM
		       (SELECT
		           title, t.tname dir, bno
		        FROM 
		            board b, thumb t
		        WHERE 
		           b.tno = t.tno
		           <foreach item="ingred" collection="array" open="AND ingred LIKE '%' || " close=" || '%'" separator=" || '%' AND ingred LIKE '%' || ">
		           		#{ingred}
		           </foreach>
		        ORDER BY
		           title DESC) b)
		WHERE
		    bono  BETWEEN 1 AND 5
	</select>
	
	
	<update id="addLikeCnt" parameterType="int">
		UPDATE
		    board
		SET
		    lcount = lcount + 1
		WHERE
		    bno = #{bno}
	</update>
	
	<insert id="addUserLikeCnt" parameterType="rVO">
		INSERT INTO 
		    userlike(lno, lmno, lbno, ldate)
		VALUES(
		    (SELECT NVL(MAX(lno) + 1, 10001) FROM userlike),
		    #{mno}, #{bno}, sysdate
		)
	</insert>
	
	<insert id="addReply" parameterType="rVO">
		INSERT INTO
		    reply(reno, rebno, body, remno, redate)
		VALUES(
		    (SELECT NVL(MAX(reno) + 1, 10001) FROM reply),
		    #{bno} , #{body} , #{mno}, sysdate
		)
	</insert>
	
	<update id="addCnt">
		UPDATE 
		    board 
		SET 
		    cnt = cnt + 1 
		WHERE 
		    bno = #{bno}
	</update>
</mapper>